name: Release

on:
  push:
    tags:
      - '*'

jobs:
  # ==================== Job 1: PyInstaller 快速构建 ====================
  build-pyinstaller:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.8.6
      uses: actions/setup-python@v5
      with:
        python-version: 3.8.6

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build with PyInstaller
      run: |
        pyinstaller classroom_lottery.spec

    - name: Prepare PyInstaller Artifacts
      run: |
        mkdir dist_py
        # 复制 PyInstaller 构建输出
        Copy-Item -Path "dist\classroom_lottery\*" -Destination "dist_py\" -Recurse -Force
        
        # 确保 assets 目录存在并复制必要文件
        mkdir dist_py\assets -ErrorAction SilentlyContinue
        Copy-Item -Path "assets\rise_enable.wav" -Destination "dist_py\assets\" -Force
        Copy-Item -Path "assets\icon.ico" -Destination "dist_py\assets\" -Force

    - name: Create PyInstaller Archive
      shell: pwsh
      run: |
        $tag = "${{ github.ref }}".Substring("${{ github.ref }}".LastIndexOf('/') + 1)
        Compress-Archive -Path dist_py\* -DestinationPath "classroom_lottery_pyinstaller_$tag.zip" -Force

    - name: Upload PyInstaller Artifact
      uses: actions/upload-artifact@v4
      with:
        name: pyinstaller-artifact
        path: classroom_lottery_pyinstaller_*.zip
        retention-days: 7

  # ==================== Job 2: PyInstaller 独立发布 ====================
  release-pyinstaller:
    needs: [build-pyinstaller]
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Download PyInstaller Artifact
      uses: actions/download-artifact@v4
      with:
        name: pyinstaller-artifact

    - name: Release PyInstaller Version
      uses: softprops/action-gh-release@v1
      with:
        files: |
          *.zip
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================== Job 3: Nuitka 矩阵并行构建 (去脚本化) ====================
  build-nuitka:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        # 将原 build.ps1 中的配置直接转换为 CI 矩阵参数
        include:
          - name: main
            script: main.py
            icon: assets/icon.ico
            plugin: pyside2
            console: disable
            includes: pyttsx3,pyttsx3.drivers,keyboard,PIL,psutil
            excludes: matplotlib,notebook,jupyter,IPython,pytest,sphinx,pandas
          - name: daemon
            script: daemon.py
            icon: assets/daemon.ico
            plugin: ""
            console: disable
            includes: psutil
            excludes: PySide2,PIL,pyttsx3,winsound,keyboard,matplotlib,notebook,jupyter,IPython,pandas
          - name: launcher
            script: launcher.py
            icon: assets/launcher.ico
            plugin: pyside2
            console: disable
            includes: psutil,openpyxl
            excludes: matplotlib,pyttsx3,winsound,keyboard,pandas,notebook,jupyter,IPython
          - name: update
            script: update.py
            icon: assets/update.ico
            plugin: pyside2
            console: disable
            includes: requests,tqdm,psutil
            excludes: matplotlib,pyttsx3,winsound,keyboard,PIL,pandas,notebook,jupyter,IPython

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.8.6
      uses: actions/setup-python@v5
      with:
        python-version: 3.8.6

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install nuitka ordered-set zstandard

    - name: Build Nuitka Target (${{ matrix.name }})
      shell: pwsh
      run: |
        # --- 参数准备 ---
        $includes = "${{ matrix.includes }}".Split(',') | Where-Object { $_ -ne "" }
        $excludes = "${{ matrix.excludes }}".Split(',') | Where-Object { $_ -ne "" }
        
        # --- 版本号逻辑 ---
        $version = "1.0.0.0"
        $verFile = "version_info_${{ matrix.name }}.txt"
        if (-not (Test-Path $verFile)) { $verFile = "version_info.txt" }
        if (Test-Path $verFile) { 
            $content = Get-Content $verFile -TotalCount 1
            if ($content -match "^\d+\.\d+\.\d+\.\d+$") { $version = $content }
        }
        Write-Host "Using Version: $version"

        # --- 图标路径逻辑 ---
        $iconPath = "${{ matrix.icon }}"
        if (-not (Test-Path $iconPath)) { 
            Write-Warning "特定图标未找到: $iconPath，尝试默认图标。"
            $iconPath = "assets/icon.ico"
            if (-not (Test-Path $iconPath)) { $iconPath = $null }
        }

        # --- 构建 Nuitka 参数列表 ---
        $nuitkaArgs = @(
            "--standalone"
            "--output-dir=dist"
            "--remove-output"
            "--assume-yes-for-downloads"
            "--lto=yes"
            "--windows-console-mode=${{ matrix.console }}"
        )

        # 插件
        if ("${{ matrix.plugin }}" -ne "") {
            $nuitkaArgs += "--enable-plugin=${{ matrix.plugin }}"
        }

        # 图标
        if ($iconPath) {
            $nuitkaArgs += "--windows-icon-from-ico=$iconPath"
        }

        # 版本
        $nuitkaArgs += "--windows-file-version=$version"
        $nuitkaArgs += "--windows-product-version=$version"
        
        # --- 资源文件处理 (仅包含指定文件) ---
        $nuitkaArgs += "--include-data-files=assets/rise_enable.wav=assets/rise_enable.wav"
        $nuitkaArgs += "--include-data-files=assets/icon.ico=assets/icon.ico"

        # 包含包
        foreach ($inc in $includes) { $nuitkaArgs += "--include-package=$inc" }
        
        # 排除包
        foreach ($exc in $excludes) { $nuitkaArgs += "--nofollow-import-to=$exc" }
        
        # 目标脚本
        $nuitkaArgs += "${{ matrix.script }}"
        
        # --- 执行构建 ---
        Write-Host "Executing: python -m nuitka @nuitkaArgs"
        & python -m nuitka @nuitkaArgs
        
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

    - name: Prepare Single Artifact
      shell: pwsh
      run: |
        # Nuitka 默认输出在 dist/<ScriptName>.dist (如 main.dist)
        $distFolder = "dist\${{ matrix.name }}.dist"
        
        if (Test-Path $distFolder) {
            # 直接打包 .dist 目录下的所有内容
            Compress-Archive -Path "$distFolder\*" -DestinationPath "nuitka_part_${{ matrix.name }}.zip" -Force
        } else {
            Write-Error "未找到构建目录: $distFolder"
            exit 1
        }

    - name: Upload Nuitka Part Artifact
      uses: actions/upload-artifact@v4
      with:
        name: nuitka-part-${{ matrix.name }}
        path: nuitka_part_${{ matrix.name }}.zip
        retention-days: 7

  # ==================== Job 4: Nuitka 合并与追加发布 ====================
  merge-and-release-nuitka:
    needs: [build-nuitka]
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Download All Nuitka Parts
      uses: actions/download-artifact@v4

    - name: Merge Nuitka Parts
      shell: pwsh
      run: |
        Write-Host "开始合并 Nuitka 构建产物..." -ForegroundColor Cyan
        
        # 创建最终合并目录
        $FinalDir = "classroom_lottery_merged"
        New-Item -ItemType Directory -Path $FinalDir -Force | Out-Null

        # 遍历所有下载的 part zip 包
        Get-ChildItem -Filter "nuitka_part_*.zip" | ForEach-Object {
            Write-Host "正在处理: $($_.Name)" -ForegroundColor Gray
            
            # 临时解压目录
            $TempExtract = "temp_extract_$($_.BaseName)"
            Expand-Archive -Path $_.FullName -DestinationPath $TempExtract -Force

            # 1. 移动所有 EXE 到根目录
            $Exes = Get-ChildItem -Path $TempExtract -Filter "*.exe"
            foreach ($Exe in $Exes) {
                Copy-Item -Path $Exe.FullName -Destination "$FinalDir\$($Exe.Name)" -Force
            }

            # 2. 移动所有依赖文件 (dll, pyd) 到根目录 (跳过已存在的)
            $Deps = Get-ChildItem -Path $TempExtract -File | Where-Object { $_.Extension -in @('.dll', '.pyd', '.so') }
            foreach ($Dep in $Deps) {
                $Dest = "$FinalDir\$($Dep.Name)"
                if (-not (Test-Path $Dest)) {
                    Copy-Item -Path $Dep.FullName -Destination $Dest -Force
                }
            }

            # 3. 处理 assets 文件夹 (只包含 rise_enable.wav 和 icon.ico)
            if (Test-Path "$TempExtract\assets") {
                $DestAssets = "$FinalDir\assets"
                if (-not (Test-Path $DestAssets)) {
                    Copy-Item -Path "$TempExtract\assets" -Destination $FinalDir -Recurse -Force
                } else {
                    Get-ChildItem -Path "$TempExtract\assets" -Recurse | ForEach-Object {
                        $RelativePath = $_.FullName.Substring("$TempExtract\assets".Length + 1)
                        $FinalTarget = "$FinalDir\assets\$RelativePath"
                        $TargetDir = Split-Path -Parent $FinalTarget
                        if (-not (Test-Path $TargetDir)) { New-Item -ItemType Directory -Path $TargetDir -Force | Out-Null }
                        Copy-Item -Path $_.FullName -Destination $FinalTarget -Force
                    }
                }
            }
            
            # 4. 处理 lib 文件夹 (如果存在)
            if (Test-Path "$TempExtract\lib") {
                 $DestLib = "$FinalDir\lib"
                 Copy-Item -Path "$TempExtract\lib" -Destination $FinalDir -Recurse -Force
            }

            # 清理临时文件
            Remove-Item -Path $TempExtract -Recurse -Force
        }

        # 最终打包
        $tag = "${{ github.ref }}".Substring("${{ github.ref }}".LastIndexOf('/') + 1)
        Compress-Archive -Path "$FinalDir\*" -DestinationPath "classroom_lottery_nuitka_$tag.zip" -Force
        
        # 清理 workspace，只保留最终 zip
        Get-ChildItem -Exclude "*.zip" | Remove-Item -Recurse -Force
        Get-ChildItem -Filter "nuitka_part_*.zip" | Remove-Item -Force

    - name: Release Nuitka Version (Append)
      uses: softprops/action-gh-release@v1
      with:
        files: |
          classroom_lottery_nuitka_*.zip
        generate_release_notes: false
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
