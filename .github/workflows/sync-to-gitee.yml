name: Sync GitHub Release to Gitee

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  GITHUB_OWNER: trustedinster
  GITHUB_REPO: classroom_lottery
  GITEE_OWNER: Bilibili-Supercmd
  GITEE_REPO: classroom_lottery
  GIT_USER_NAME: BiliBili UP主Supercmd
  GIT_USER_EMAIL: trustedinster@outlook.com

jobs:
  sync-to-gitee:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 设置 Git 用户信息
      - name: Configure Git
        run: |
          git config --global user.name "${{ env.GIT_USER_NAME }}"
          git config --global user.email "${{ env.GIT_USER_EMAIL }}"

      # 3. 同步代码到 Gitee
      - name: Mirror GitHub to Gitee
        uses: Yikun/hub-mirror-action@master
        with:
          src: github/${{ env.GITHUB_OWNER }}
          dst: gitee/${{ env.GITEE_OWNER }}
          dst_key: ${{ secrets.RSA_PRIVATE_KEY }}
          dst_token: ${{ secrets.GITEE_TOKEN }}
          force_update: true
          static_list: "classroom_lottery"

      # 4. 上传到 Gitee
      - name: sync-github-release-to-gitee
        uses: trustedinster/sync-release-gitee@v1.3
        with:
          gitee_owner: ${{ env.GITEE_OWNER }}
          gitee_repo: ${{ env.GITEE_REPO }}
          gitee_token: ${{ secrets.gitee_token }}
          github_owner: ${{ env.GITHUB_OWNER }}
          github_repo: ${{ env.GITHUB_REPO }}
          gitee_upload_retry_times:  3

      # 5. 清理临时文件
      - name: Cleanup
        if: always()
        run: rm -rf assets

      # 6. 错误处理
      - name: Error Handling
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // 只有在 pull request 或 issue 中才能发送评论
            if (context.issue && context.issue.number) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '同步 Release 到 Gitee 失败，请检查错误日志。'
              });
            }