name: Sync GitHub Release to Gitee

# 触发条件：当 Release 被创建时自动触发
on:
  release:
    types: [published, edited]

# 环境变量设置
env:
  # 仓库信息
  GITHUB_REPO: trustedinster/classroom_lottery
  GITEE_OWNER: Bilibili-Supercmd
  GITEE_REPO: classroom_lottery
  # Git 用户配置
  GIT_USER_NAME: BiliBili UP主Supercmd
  GIT_USER_EMAIL: trustedinster@outlook.com

jobs:
  sync-to-gitee:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 设置 Git 用户信息
      - name: Configure Git
        run: |
          git config --global user.name "${{ env.GIT_USER_NAME }}"
          git config --global user.email "${{ env.GIT_USER_EMAIL }}"

      # 3. 同步代码到 Gitee
      - name: Mirror GitHub to Gitee
        uses: Yikun/hub-mirror-action@master
        with:
          src: github/${{ env.GITHUB_REPO }}
          dst: gitee/${{ env.GITEE_OWNER }}/${{ env.GITEE_REPO }}
          dst_key: ${{ secrets.RSA_PRIVATE_KEY }}
          dst_token: ${{ secrets.GITEE_TOKEN }}
          force_update: true
          static_list: "classroom_lottery"

      # 4. 获取 GitHub Release 信息
      - name: Get Release Info
        id: get_release
        uses: actions/github-script@v6
        with:
          script: |
            // 获取 Release 信息
            const release = await github.rest.repos.getRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id
            });

            // 获取所有 Release 附件
            const assets = await github.rest.repos.listReleaseAssets({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id
            });

            // 下载所有附件
            const fs = require('fs');
            const path = require('path');
            const assetsDir = path.join(process.cwd(), 'assets');
            if (!fs.existsSync(assetsDir)) {
              fs.mkdirSync(assetsDir);
            }

            for (const asset of assets.data) {
              const response = await github.rest.repos.getReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                asset_id: asset.id,
                headers: {
                  Accept: 'application/octet-stream'
                }
              });

              const assetPath = path.join(assetsDir, asset.name);
              fs.writeFileSync(assetPath, Buffer.from(response.data));
            }

            // 返回 Release 信息
            return {
              tag_name: release.data.tag_name,
              name: release.data.name,
              body: release.data.body,
              draft: release.data.draft,
              prerelease: release.data.prerelease,
              assets_dir: assetsDir,
              target_commitish: release.data.target_commitish
            }

      # 5. 创建 Gitee Release
      - name: Create Gitee Release
        id: create_release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          # 准备请求数据
          RELEASE_DATA=$(jq -n \
            --arg tag_name "${{ steps.get_release.outputs.tag_name }}" \
            --arg name "${{ steps.get_release.outputs.name }}" \
            --arg body "${{ steps.get_release.outputs.body }}" \
            --arg target_commitish "${{ steps.get_release.outputs.target_commitish }}" \
            --argjson prerelease "${{ steps.get_release.outputs.prerelease }}" \
            '{
              tag_name: $tag_name,
              name: $name,
              body: $body,
              target_commitish: $target_commitish,
              prerelease: $prerelease
            }')

          # 发送请求创建 Release
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: token $GITEE_TOKEN" \
            -d "$RELEASE_DATA" \
            "https://gitee.com/api/v5/repos/${{ env.GITEE_OWNER }}/${{ env.GITEE_REPO }}/releases")

          # 检查响应并提取 Release ID
          if echo "$RESPONSE" | jq -e 'has("id")' > /dev/null; then
            RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')
            echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          else
            echo "创建 Release 失败: $RESPONSE"
            exit 1
          fi

      # 6. 上传附件到 Gitee
      - name: Upload Assets to Gitee
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          # 获取所有附件文件
          for file in "${{ steps.get_release.outputs.assets_dir }}"/*; do
            if [ -f "$file" ]; then
              # 使用 curl 上传文件
              RESPONSE=$(curl -s -X POST \
                -H "Authorization: token $GITEE_TOKEN" \
                -F "file=@$file" \
                "https://gitee.com/api/v5/repos/${{ env.GITEE_OWNER }}/${{ env.GITEE_REPO }}/releases/${{ steps.create_release.outputs.release_id }}/attach_files")

              # 检查上传结果
              if ! echo "$RESPONSE" | jq -e 'has("id")' > /dev/null; then
                echo "上传文件失败: $file"
                echo "响应: $RESPONSE"
                exit 1
              fi
            fi
          done

      # 7. 清理临时文件
      - name: Cleanup
        if: always()
        run: |
          # 清理下载的附件
          rm -rf assets

      # 8. 错误处理
      - name: Error Handling
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            // 发送错误通知
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ 同步 Release 到 Gitee 失败，请检查错误日志。'
            })