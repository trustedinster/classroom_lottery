name: Sync GitHub Release to Gitee

# 触发条件：当 Release 被创建时自动触发
on:
  release:
    types: [published]

# 环境变量设置
env:
  # 仓库信息
  GITHUB_OWNER: trustedinster
  GITHUB_REPO: classroom_lottery
  GITEE_OWNER: Bilibili-Supercmd
  GITEE_REPO: classroom_lottery
  # Git 用户配置
  GIT_USER_NAME: BiliBili UP主Supercmd
  GIT_USER_EMAIL: trustedinster@outlook.com

jobs:
  sync-to-gitee:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 设置 Git 用户信息
      - name: Configure Git
        run: |
          git config --global user.name "${{ env.GIT_USER_NAME }}"
          git config --global user.email "${{ env.GIT_USER_EMAIL }}"

      # 3. 同步代码到 Gitee
      - name: Mirror GitHub to Gitee
        uses: Yikun/hub-mirror-action@master
        with:
          src: github/${{ env.GITHUB_OWNER }}
          dst: gitee/${{ env.GITEE_OWNER }}
          dst_key: ${{ secrets.RSA_PRIVATE_KEY }}
          dst_token: ${{ secrets.GITEE_TOKEN }}
          force_update: true
          static_list: "classroom_lottery"
      # 4. 下载 GitHub Release
      - name: Download GitHub Release
        uses: robinraju/release-downloader@v1.12
        id: download-release
        with:
          fileName: 'classroom_lottery_${{ github.ref_name }}.zip'
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
          out-file-path: assets
      # 5. 上传到 Gitee
      - name: Upload to Gitee
        uses: nICEnnnnnnnLee/action-gitee-release@v2.0.0
        with:
          gitee_action: create_release
          gitee_token: ${{ secrets.GITEE_TOKEN }}
          gitee_owner: ${{ env.GITEE_OWNER }}
          gitee_repo: ${{ env.GITEE_REPO }}
          gitee_tag_name: ${{ github.ref_name }}
          gitee_release_name: ${{ github.event.release.title }}
          gitee_release_body: ${{ github.event.release.body }}
          gitee_target_commitish: master
          gitee_upload_retry_times: 3
          gitee_file_name: ${{ fromJson(steps.download-release.outputs.downloaded_files)[0] }}
          gitee_file_path: assets
      # 7. 清理临时文件
      - name: Cleanup
        if: always()
        run: |
          # 清理下载的附件
          rm -rf assets

      # 8. 错误处理
      - name: Error Handling
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // 发送错误通知
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ 同步 Release 到 Gitee 失败，请检查错误日志。'
            })